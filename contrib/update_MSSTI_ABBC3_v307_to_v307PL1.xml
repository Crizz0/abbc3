<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
	<header>
		<license><![CDATA[http://opensource.org/licenses/gpl-license.php GNU General Public License v2]]></license>

		<title lang="en"><![CDATA[Advanced BBCode Box 3 (aka ABBC3) - Update from 3.0.7 to 3.0.7-PL1]]></title>

		<description lang="en"><![CDATA[This file provides instructions for upgrading ABBC3 MOD from version 3.0.7 to version 3.0.7-PL1]]></description>

		<author-notes lang="en"><![CDATA[
	-------------------------------------------------------------------

	See the main install file for any additional information about the MOD.

	You will have to make this change to ALL themes you have installed, based off Prosilver and Subsilver2.

	-------------------------------------------------------------------
	IMPORTANT !

	Before made any changes, makes sure your template is stored into "filesystem"
	    ACP -> STYLES -> STYLE COMPONENTS -> Templates : subsilver2 -> Details

	If you do not want to change from "Database" to "Filesystem",
	you must do next changes within your ACP :
	    ACP -> STYLES -> STYLE COMPONENTS -> Templates : subsilver2 -> Edit

	-------------------------------------------------------------------

	Before adding this MOD to your forum, you should back up all files and databases related to this MOD.]]></author-notes>

		<author-group>
			<author>
				<realname><![CDATA[Gabriel]]></realname>
				<username><![CDATA[leviatan21]]></username>
				<homepage><![CDATA[http://www.mssti.com/phpbb3/]]></homepage>
				<email><![CDATA[info@mssti.com]]></email>
				<contributions-group>
					<contributions status="current" from="2008-01-10" position="Developer"/>
				</contributions-group>
			</author>

			<author>
				<username><![CDATA[VSE]]></username>
				<contributions-group>
					<contributions status="current" from="2010-03-02" position="Contributor"/>
				</contributions-group>
			</author>
		</author-group>

		<mod-version>3.0.7-PL1</mod-version>

		<installation>
			<level>intermediate</level>
			<time>1200</time>
			<target-version>3.0.7-PL1</target-version>
		</installation>

		<link-group>
			<link type="parent" href="../install_ABBC3.xml" lang="en">Code change</link>
			<link type="contrib" href="../root/install_abbc3.php" lang="en">Database update</link>
		</link-group>
	</header>

	<action-group>

		<copy>
			<file from="root/abbcode_page.php" to="abbcode_page.php"/>
			<file from="root/adm/style/*.*" to="adm/style/*.*"/>
			<file from="root/images/*.*" to="images/*.*"/>
			<file from="root/includes/*.*" to="includes/*.*"/>
			<file from="root/install_abbc3.php" to="install_abbc3.php"/>
			<file from="root/language/en/mods/*.*" to="language/en/mods/*.*"/>
			<file from="root/styles/abbcode/*.*" to="styles/abbcode/*.*"/>
			<file from="root/styles/prosilver/template/*.*" to="styles/prosilver/template/*.*"/>
			<file from="root/styles/subsilver2/template/*.*" to="styles/subsilver2/template/*.*"/>
		</copy>

		<php-installer><![CDATA[install_abbc3.php]]></php-installer>

		<open src="adm/style/acp_users_signature.html">
			<edit>
				<find><![CDATA[<p>{SIGNATURE_PREVIEW}</p>]]></find>
				<action type="replace-with"><![CDATA[<div id="sig" class="signature"><p>{SIGNATURE_PREVIEW}</p></div>]]></action>
			</edit>

			<edit>
				<find><![CDATA[			<dt style="width: 100%;"><textarea name="signature" id="signature" rows="10" cols="60" style="width: 100%; height: 300px;"]]></find>
				<inline-edit>
					<inline-find><![CDATA[style="width: 100%; height: 300px;"]]></inline-find>
					<inline-action type="replace-with"><![CDATA[style="width: 99%; height: 300px;"]]></inline-action>
				</inline-edit>
			</edit>
		</open>

		<open src="includes/functions.php">
			<edit>
				<find><![CDATA[	// The following assigns all _common_ variables that may be used at any point in a template.]]></find>
				<action type="before-add"><![CDATA[// MOD : MSSTI ABBC3 - Start
	if (defined('IN_ABBC3'))
	{
		$user->add_lang('mods/abbcode');
	}
// MOD : MSSTI ABBC3 - End]]></action>
			</edit>
		</open>

		<open src="includes/message_parser.php">
			<edit>
				<find><![CDATA[// MOD : MSSTI ABBC3 - Start
		// Check ABBC3 groups permission
		foreach ($this->bbcodes as $bbcode_name => $bbcode_data)
		{
			if (isset($bbcode_data['bbcode_group']) && $bbcode_data['bbcode_group'] && !$this->abbode_phpbb_auth($bbcode_data['bbcode_group']))
			{
				$this->bbcodes[$bbcode_name]['disabled'] = true;
			}
		}
// MOD : MSSTI ABBC3 - End]]></find>
				<action type="replace-with"><![CDATA[// MOD : MSSTI ABBC3 - Start
		// Check phpbb permissions status
		// Check ABBC3 groups permission
		// try to make it as quicky as it can be 
		foreach ($this->bbcodes as $bbcode_name => $bbcode_data)
		{
			$auth_tag = preg_replace('#\=(.*)?#', '', strtoupper(trim($bbcode_name)));
			if ((isset($bbcode_data['bbcode_group']) && $bbcode_data['bbcode_group']) || in_array($auth_tag, $this->need_permissions))
			{
				if (!$this->abbcode_permissions($auth_tag, (isset($bbcode_data['bbcode_group']) ? $bbcode_data['bbcode_group'] : 0)))
				{
					$this->bbcodes[$bbcode_name]['disabled'] = true;				
				}
			}
		}
// MOD : MSSTI ABBC3 - End]]></action>
			</edit>
		</open>

		<open src="styles/prosilver/template/posting_preview.html">
			<edit>
				<find><![CDATA[<!-- IF PREVIEW_SIGNATURE --><div class="signature">{PREVIEW_SIGNATURE}</div><!-- ENDIF -->]]></find>
				<inline-edit>
					<inline-find><![CDATA[ class="signature"]]></inline-find>
					<inline-action type="before-add"><![CDATA[ id="sig"]]></inline-action>
				</inline-edit>
			</edit>
		</open>

		<open src="styles/prosilver/template/ucp_profile_signature.html">
			<edit>
				<find><![CDATA[<div class="signature" style="border-top:none; margin-top: 0; ">{SIGNATURE_PREVIEW}</div>]]></find>
				<inline-edit>
					<inline-find><![CDATA[ class="signature"]]></inline-find>
					<inline-action type="before-add"><![CDATA[ id="sig"]]></inline-action>
				</inline-edit>
			</edit>
		</open>

		<open src="styles/subsilver2/template/posting_preview.html">
			<edit>
				<find><![CDATA[<!-- IF PREVIEW_SIGNATURE -->]]></find>
				<find><![CDATA[<span class="postbody">]]></find>
				<inline-edit>
					<inline-find><![CDATA[ class="postbody"]]></inline-find>
					<inline-action type="before-add"><![CDATA[ id="sig"]]></inline-action>
				</inline-edit>
			</edit>
		</open>

		<open src="styles/subsilver2/template/ucp_pm_viewmessage.html">
			<edit>
				<find><![CDATA[				<!-- IF SIGNATURE -->]]></find>
				<find><![CDATA[					<span class="postbody">]]></find>
				<inline-edit>
					<inline-find><![CDATA[ class="postbody"]]></inline-find>
					<inline-action type="before-add"><![CDATA[ id="sig"]]></inline-action>
				</inline-edit>				
			</edit>
		</open>

		<open src="styles/subsilver2/template/ucp_profile_signature.html">
			<edit>
				<find><![CDATA[<td class="row1" colspan="2"><div class="postbody" style="padding: 6px;">{SIGNATURE_PREVIEW}</div></td>]]></find>
				<inline-edit>
					<inline-find><![CDATA[ class="postbody"]]></inline-find>
					<inline-action type="before-add"><![CDATA[ id="sig"]]></inline-action>
				</inline-edit>
			</edit>
		</open>

		<diy-instructions lang="en"><![CDATA[IMPORTANT !

OVERWRITE all your previous files with the new ones!

Please make sure of it, some FTP programs don't do it fine.

Makes sure you follow the DIY instruction in the main Install_ABBC3.xml file.]]></diy-instructions>

	</action-group>
</mod>